#!/bin/zsh
# Zsh Modular Configuration Loader
# 
# This script recursively loads all .zsh module files from the modules/ directory.
# Modules are loaded in directory order: 0-system/ → 1-lang/ → 2-editor/
# Within each directory, files are loaded in alphabetical order.
#
# Usage: Source this file from .zshrc
# Debug: Set DEBUG=true to see which modules are loaded

ZSH_CONFIG_DIR="$HOME/.config/zsh"

# DEBUG=true  # Uncomment to enable debug output

_is_valid_zsh_module() { [[ -f "$1" && "$1" == *.zsh && -r "$1" ]] }

_debug_echo() { [[ "$DEBUG" == "true" ]] && echo "$1"; }

_source_all_recursively() {                     # Source all zsh modules in directory recursively
    if [ -d "$1" ]; then                          # Check if the passed dir is a valid directory
        # Use NULL_GLOB to handle empty directories gracefully
        setopt NULL_GLOB 2>/dev/null || true
        for entry in "$1"/*; do                     # For each entry in the directory
            if _is_valid_zsh_module "$entry"; then   # IF entry is a valid zsh module file
                _debug_echo "Sourcing $entry"           # DEBUG: output the sourced file
                source "$entry"                         # Source the file
            elif [ -d "$entry" ]; then                # ELSE IF entry is a directory
              _debug_echo "Recursing -> $entry"         # DEBUG: output
              _source_all_recursively "$entry"          # Recurse into subdirectory
            fi
        done
        unsetopt NULL_GLOB 2>/dev/null || true
    fi
}

_source_all_recursively "$ZSH_CONFIG_DIR/modules"
